#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# MANAGE SCRIPT FAILURE
#=================================================

ynh_clean_setup () {
	### Remove this function if there's nothing to clean before calling the remove script.
	true
}
# Exit if an error occurs during the execution of the script
ynh_abort_if_errors

#=================================================
# RETRIEVE ARGUMENTS FROM THE MANIFEST
#=================================================

domain=$YNH_APP_ARG_DOMAIN
path_url=$YNH_APP_ARG_PATH
admin=$YNH_APP_ARG_ADMIN
channel=$YNH_APP_ARG_CHANNEL

app=$YNH_APP_INSTANCE_NAME

# Configurable variables
sync_home="/home/yunohost.app/$app"
sync_user=debian-syncthing
sync_port=22000
gui_port=8384

#=================================================
# CHECK IF THE APP CAN BE INSTALLED WITH THESE ARGS
#=================================================
ynh_print_info "Validating installation parameters..."

# Register (book) web path
ynh_webpath_register $app $domain $path_url

#=================================================
# STORE SETTINGS FROM MANIFEST
#=================================================
ynh_print_info "Storing installation settings..."

ynh_app_setting_set $app domain $domain
ynh_app_setting_set $app path $path_url
ynh_app_setting_set $app admin $admin
ynh_app_setting_set $app channel $channel
ynh_app_setting_set $app sync_home $sync_home
ynh_app_setting_set $app sync_user $sync_user

#=================================================
# STANDARD MODIFICATIONS
#=================================================
# FIND AND OPEN A PORT
#=================================================
ynh_print_info "Configuring firewall..."

# Check port availability
sudo yunohost app checkport $gui_port
if [[ ! $? -eq 0 ]]; then
  echo Port $gui_port for Syncthing UI is not available.
  exit 1
fi
ynh_app_setting_set $app gui_port $gui_port

sudo yunohost app checkport $sync_port
if [[ ! $? -eq 0 ]]; then
  echo Port $sync_port for Syncthing protocol is not available.
  exit 1
fi

# Open this port
ynh_exec_warn_less yunohost firewall allow --no-upnp TCP $sync_port
ynh_app_setting_set $app sync_port $sync_port

#=================================================
# INSTALL DEPENDENCIES
#=================================================
ynh_print_info "Installing dependencies..."

ynh_install_app_dependencies $pkg_dependencies

## Add the release PGP keys:
curl -s https://syncthing.net/release-key.txt | sudo apt-key add -
## Add the choosed channel to your APT sources:
echo "deb http://apt.syncthing.net/ syncthing $channel" | sudo tee /etc/apt/sources.list.d/syncthing.list
## Update and install syncthing:
sudo apt-get update -qq
sudo apt-get install syncthing -y --force-yes

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_print_info "Configuring nginx web server..."

# Create a dedicated nginx config
ynh_add_nginx_config "gui_port"

#=================================================
# CREATE DEDICATED USER
#=================================================
ynh_print_info "Configuring system user..."

# Create a system user
ynh_system_user_create --username=$sync_user --home_dir=$sync_home/ --use_shell

#=================================================
# SPECIFIC SETUP
#=================================================
# CREATE SYNC DIRECTORY
#=================================================
ynh_print_info "Creating sync directory..."

# Make directories and set rights
sudo chown -R $sync_user:$sync_user $sync_home/
sudo find $sync_home/ -type f | while read LINE; do sudo chmod 640 "$LINE" ; done
sudo find $sync_home/ -type d | while read LINE; do sudo chmod 750 "$LINE" ; done

#=================================================
# SETUP SYSTEMD
#=================================================
ynh_print_info "Configuring a systemd service..."

# Install and monitor service
sudo sed -i '/^\[Service\]$/,/^\[/ s/^Restart=on-failure/Restart=always/' /lib/systemd/system/syncthing@.service
sudo systemctl daemon-reload
sudo systemctl enable syncthing@$sync_user.service
sudo yunohost service add syncthing@$sync_user -l /var/log/syncthing.log
sudo systemctl start syncthing@$sync_user.service

#=================================================
# GENERIC FINALIZATION
#=================================================
# SECURE FILES AND DIRECTORIES
#=================================================

# Remove acces to all users
sudo yunohost app removeaccess syncthing
sudo yunohost app addaccess syncthing -u $admin

#=================================================
# SETUP LOGROTATE
#=================================================
ynh_print_info "Configuring log rotation..."

# Use logrotate to manage application logfile(s)
ynh_use_logrotate

#=================================================
# SETUP SSOWAT
#=================================================
ynh_print_info "Configuring SSOwat..."

# Make app public
ynh_app_setting_set $app unprotected_uris "/"

#=================================================
# RELOAD NGINX
#=================================================
ynh_print_info "Reloading nginx web server..."

systemctl reload nginx

#=================================================
# END OF SCRIPT
#=================================================

ynh_print_info "Installation of $app completed"
