#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# MANAGE SCRIPT FAILURE
#=================================================

ynh_clean_setup () {
	### Remove this function if there's nothing to clean before calling the remove script.
	true
}
# Exit if an error occurs during the execution of the script
ynh_abort_if_errors

#=================================================
# RETRIEVE ARGUMENTS FROM THE MANIFEST
#=================================================

domain=$YNH_APP_ARG_DOMAIN
path=$YNH_APP_ARG_PATH
user=$YNH_APP_ARG_ADMIN
channel=$YNH_APP_ARG_CHANNEL

app=$YNH_APP_INSTANCE_NAME



# Configurable variables
SYNCHOME="/home/yunohost.app/syncthing"
SYNCUSER=debian-syncthing
SYNCPORT=22000
GUIPORT=8384

#=================================================
# CHECK IF THE APP CAN BE INSTALLED WITH THESE ARGS
#=================================================
ynh_print_info "Validating installation parameters..."



# Register (book) web path
ynh_webpath_register $app $domain $path

#=================================================
# STORE SETTINGS FROM MANIFEST
#=================================================
ynh_print_info "Storing installation settings..."

ynh_app_setting_set $app domain $domain
ynh_app_setting_set $app path $path
ynh_app_setting_set $app user $user
ynh_app_setting_set $app channel $channel

#=================================================
# STANDARD MODIFICATIONS
#=================================================
# FIND AND OPEN A PORT
#=================================================
ynh_print_info "Configuring firewall..."

# Check port availability
sudo yunohost app checkport $GUIPORT
if [[ ! $? -eq 0 ]]; then
  echo Port $GUIPORT for Syncthing UI is not available.
  exit 1
fi
ynh_app_setting_set $app guiport $GUIPORT

sudo yunohost app checkport $SYNCPORT
if [[ ! $? -eq 0 ]]; then
  echo Port $SYNCPORT is for Syncthing protocol is not available.
  exit 1
fi

# Open this port
ynh_exec_warn_less yunohost firewall allow --no-upnp TCP $SYNCPORT
ynh_app_setting_set $app syncport $SYNCPORT

#=================================================
# CREATE DEDICATED USER
#=================================================
ynh_print_info "Configuring system user..."

# Create a system user
ynh_system_user_create --username=$SYNCUSER --home_dir=$SYNCHOME/ --use_shell

#=================================================
# CREATE SYNC DIRECTORY
#=================================================
ynh_print_info "Creating sync directory..."

# Make directories and set rights
sudo chown -R $SYNCUSER:$SYNCUSER $SYNCHOME/
sudo find $SYNCHOME/ -type f | while read LINE; do sudo chmod 640 "$LINE" ; done
sudo find $SYNCHOME/ -type d | while read LINE; do sudo chmod 750 "$LINE" ; done

#=================================================
# INSTALL DEPENDENCIES
#=================================================
ynh_print_info "Installing dependencies..."

# Download and install syncthing binary
sudo apt-get install curl
## Add the release PGP keys:
curl -s https://syncthing.net/release-key.txt | sudo apt-key add -
## Add the choosed channel to your APT sources:
echo "deb http://apt.syncthing.net/ syncthing $channel" | sudo tee /etc/apt/sources.list.d/syncthing.list
## Update and install syncthing:
sudo apt-get update -qq
sudo apt-get install syncthing -y --force-yes

#=================================================
# SETUP SYSTEMD
#=================================================
ynh_print_info "Configuring a systemd service..."

# Install and monitor service
sudo sed -i '/^\[Service\]$/,/^\[/ s/^Restart=on-failure/Restart=always/' /lib/systemd/system/syncthing@.service
sudo systemctl daemon-reload
sudo systemctl enable syncthing@$SYNCUSER.service
sudo yunohost service add syncthing@$SYNCUSER -l /var/log/syncthing.log
sudo systemctl start syncthing@$SYNCUSER.service

#=================================================
# SETUP LOGROTATE
#=================================================
ynh_print_info "Configuring log rotation..."

# Configure logrotate if present
if [ -d "/etc/logrotate.d" ]; then
  sed -i "s@SYNCUSER@$SYNCUSER@g" ../conf/logrotate.conf
  sudo cp ../conf/logrotate.conf /etc/logrotate.d/syncthing
  sudo chmod 0644 /etc/logrotate.d/syncthing
fi

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_print_info "Configuring nginx web server..."

# Configure Nginx
sed -i "s@PATHTOCHANGE@$path@g" ../conf/nginx.conf
sed -i "s@PORTTOCHANGE@$GUIPORT@g" ../conf/nginx.conf
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/syncthing.conf

#=================================================
# GENERIC FINALIZATION
#=================================================
# SECURE FILES AND DIRECTORIES
#=================================================

# Remove acces to all users
sudo yunohost app removeaccess syncthing
sudo yunohost app addaccess syncthing -u $user

#=================================================
# SETUP SSOWAT
#=================================================
ynh_print_info "Configuring SSOwat..."

# Make app public
ynh_app_setting_set $app unprotected_uris "/"

#=================================================
# RELOAD NGINX
#=================================================
ynh_print_info "Reloading nginx web server..."

# Reload nginx and update ssowatch
sudo systemctl reload nginx.service

#=================================================
# END OF SCRIPT
#=================================================

ynh_print_info "Installation of $app completed"
