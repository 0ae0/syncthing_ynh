#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# LOAD SETTINGS
#=================================================
ynh_print_info "Loading installation settings..."

app=$YNH_APP_INSTANCE_NAME

domain=$(ynh_app_setting_get $app domain)

SYNCHOME=$(ynh_app_setting_get $app synchome)
SYNCUSER=$(ynh_app_setting_get $app syncuser)
SYNCPORT=$(ynh_app_setting_get $app syncport)
GUIPORT=$(ynh_app_setting_get $app guiport)

final_path=$(ynh_app_setting_get $app final_path)



# Retrieve arguments
domain=$(sudo yunohost app setting syncthing domain)
path=$(sudo yunohost app setting syncthing path)

# Remove trailing "/" for next commands
path=${path%/}

# Upgrade official debian package
sudo apt-get update -qq
sudo apt-get upgrade syncthing -y

# Update Nginx configuration
sed -i "s@PATHTOCHANGE@$path@g" ../conf/nginx.conf
sed -i "s@PORTTOCHANGE@$GUIPORT@g" ../conf/nginx.conf
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/syncthing.conf

# And reload
sudo service nginx reload
sudo yunohost app ssowatconf

echo $?
