#!/bin/bash

# Configurable variables
SYNCHOME="/home/yunohost.app/syncthing"
SYNCUSER=debian-syncthing
SYNCPORT=22000
GUIPORT=8384

# Stop and remove syncthing service
sudo systemctl stop syncthing@$SYNCUSER.service
sudo yunohost service remove syncthing
sudo systemctl disable syncthing@$SYNCUSER.service

#=================================================
# REMOVE DEPENDENCIES
#=================================================
ynh_print_info "Removing dependencies"

# Remove metapackage and its dependencies
ynh_remove_app_dependencies

# Remove syncthing binairy
sudo apt-get autoremove syncthing -y --purge
sudo rm /etc/apt/sources.list.d/syncthing.list
sudo apt-get update -qq

# Backup syncthing SYNCHOME directory
sudo mv $SYNCHOME $SYNCHOME.old
# sudo rm -rf $SYNCHOME

# Remove syncthing user
sudo userdel $SYNCUSER

# Close port in firewall
sudo yunohost firewall disallow TCP $SYNCPORT

# Remove syncthing logrotate configuration
if [ -f /etc/logrotate.d/syncthing ]
then
    sudo rm /etc/logrotate.d/syncthing
fi

# Remove syncthing nginx configuration
domain=$(sudo yunohost app setting syncthing domain)
sudo rm /etc/nginx/conf.d/$domain.d/syncthing.conf

# Reload nginx and update ssowatch
sudo systemctl reload nginx.service
sudo yunohost app ssowatconf

echo $?
