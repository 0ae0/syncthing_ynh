#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# LOAD SETTINGS
#=================================================
ynh_print_info "Loading installation settings..."

app=$YNH_APP_INSTANCE_NAME

domain=$(ynh_app_setting_get $app domain)

SYNCHOME=$(ynh_app_setting_get $app synchome)
SYNCUSER=$(ynh_app_setting_get $app syncuser)
SYNCPORT=$(ynh_app_setting_get $app syncport)
GUIPORT=$(ynh_app_setting_get $app guiport)

final_path=$(ynh_app_setting_get $app final_path)

#=================================================
# STOP AND REMOVE SERVICE
#=================================================
ynh_print_info "Stopping and removing the systemd service"

# Remove the dedicated systemd config
sudo systemctl stop syncthing@$SYNCUSER.service
sudo yunohost service remove syncthing
sudo systemctl disable syncthing@$SYNCUSER.service

#=================================================
# REMOVE DEPENDENCIES
#=================================================
ynh_print_info "Removing dependencies"

# Remove metapackage and its dependencies
ynh_remove_app_dependencies

# Remove syncthing binairy
sudo apt-get autoremove syncthing -y --purge
sudo rm /etc/apt/sources.list.d/syncthing.list
sudo apt-get update -qq

# Backup syncthing SYNCHOME directory
sudo mv $SYNCHOME $SYNCHOME.old
# sudo rm -rf $SYNCHOME


#=================================================
# GENERIC FINALIZATION
#=================================================
# REMOVE DEDICATED USER
#=================================================
ynh_print_info "Removing the dedicated system user"

# Delete a system user
sudo userdel $SYNCUSER

#=================================================
# CLOSE A PORT
#=================================================

# Close port in firewall
sudo yunohost firewall disallow TCP $SYNCPORT


#=================================================
# REMOVE LOGROTATE CONFIGURATION
#=================================================
ynh_print_info "Removing logrotate configuration"

# Remove the app-specific logrotate config
if [ -f /etc/logrotate.d/syncthing ]
then
    sudo rm /etc/logrotate.d/syncthing
fi


#=================================================
# REMOVE NGINX CONFIGURATION
#=================================================
ynh_print_info "Removing nginx web server configuration"

domain=$(sudo yunohost app setting syncthing domain)
sudo rm /etc/nginx/conf.d/$domain.d/syncthing.conf

# Reload nginx and update ssowatch
sudo systemctl reload nginx.service
sudo yunohost app ssowatconf

echo $?
