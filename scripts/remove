#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# LOAD SETTINGS
#=================================================
ynh_print_info "Loading installation settings..."

app=$YNH_APP_INSTANCE_NAME

domain=$(ynh_app_setting_get $app domain)

final_path=$(ynh_app_setting_get $app final_path)

sync_home=$(ynh_app_setting_get $app sync_home)
sync_user=$(ynh_app_setting_get $app sync_user)
sync_port=$(ynh_app_setting_get $app sync_port)
gui_port=$(ynh_app_setting_get $app gui_port)

#=================================================
# STANDARD REMOVE
#=================================================
# STOP AND REMOVE SERVICE
#=================================================
ynh_print_info "Stopping and removing the systemd service"

# Remove the dedicated systemd config
sudo systemctl stop syncthing@$sync_user.service
sudo yunohost service remove syncthing
sudo systemctl disable syncthing@$sync_user.service

#=================================================
# REMOVE DEPENDENCIES
#=================================================
ynh_print_info "Removing dependencies"

# Remove metapackage and its dependencies
ynh_remove_app_dependencies

# Remove syncthing binairy
sudo apt-get autoremove syncthing -y --purge
sudo rm /etc/apt/sources.list.d/syncthing.list
sudo apt-get update -qq

# Backup syncthing sync_home directory
sudo mv $sync_home $sync_home.old
# sudo rm -rf $sync_home






#=================================================
# REMOVE NGINX CONFIGURATION
#=================================================
ynh_print_info "Removing nginx web server configuration"

# Remove the dedicated nginx config
ynh_remove_nginx_config

# Reload nginx and update ssowatch
sudo systemctl reload nginx.service
sudo yunohost app ssowatconf

#=================================================
# REMOVE LOGROTATE CONFIGURATION
#=================================================
ynh_print_info "Removing logrotate configuration"

# Remove the app-specific logrotate config
if [ -f /etc/logrotate.d/syncthing ]
then
    sudo rm /etc/logrotate.d/syncthing
fi

#=================================================
# CLOSE A PORT
#=================================================

# Close port in firewall
sudo yunohost firewall disallow TCP $sync_port

#=================================================
# GENERIC FINALIZATION
#=================================================
# REMOVE DEDICATED USER
#=================================================
ynh_print_info "Removing the dedicated system user"

# Delete a system user
sudo userdel $sync_user

#=================================================
# END OF SCRIPT
#=================================================

ynh_print_info "Removal of $app completed"
